{"ast":null,"code":"import\"antd/lib/message/style\";import _message from\"antd/lib/message\";import _toConsumableArray from\"D:/project/lingye/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"D:/project/lingye/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import\"antd/lib/input/style\";import _Input from\"antd/lib/input\";import React,{useEffect,useRef,useState}from'react';import Cookies from\"js-cookie\";import axios from\"axios\";import'./style.less';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var TextArea=_Input.TextArea;var boy=require('../../assets/boy.png').default;var girl=require('../../assets/girl.png').default;var ChatPC=function ChatPC(){// socket\nvar ws;var httpUrl=\"http://websocket.sendcmd.com\";var wsUrl=\"ws://websocket.sendcmd.com:9004\";// let httpUrl = \"http://192.168.3.17:9004\";\n// let wsUrl = \"ws://192.168.3.17:9004\";\nvar currentUserList=useRef();var currentUserActive=useRef();// 选中的聊天用户\nvar currentChatList=useRef();// 用户聊天列表\nvar _useState=useState(),_useState2=_slicedToArray(_useState,2),userList=_useState2[0],setuserList=_useState2[1];// 客服聊天列表\nvar _useState3=useState(),_useState4=_slicedToArray(_useState3,2),chatList=_useState4[0],setchatList=_useState4[1];// 用户聊天列表\nvar _useState5=useState(),_useState6=_slicedToArray(_useState5,2),sessionIds=_useState6[0],setsessionIds=_useState6[1];var _useState7=useState(),_useState8=_slicedToArray(_useState7,2),userActive=_useState8[0],setuserActive=_useState8[1];var _useState9=useState(),_useState10=_slicedToArray(_useState9,2),userName=_useState10[0],setuseruserName=_useState10[1];var _useState11=useState(Cookies.get(\"user\")),_useState12=_slicedToArray(_useState11,1),adminUser=_useState12[0];var _useState13=useState(\"\"),_useState14=_slicedToArray(_useState13,2),msg=_useState14[0],setmessage=_useState14[1];var _useState15=useState(),_useState16=_slicedToArray(_useState15,2),myID=_useState16[0],setmyID=_useState16[1];var onClickSelectUser=function onClickSelectUser(item){setuserActive(item.key);currentUserActive.current=item.key;currentUserActive.current=item.key;setuseruserName(item.userName);};useEffect(function(){if(adminUser==='admin'){onopen(adminUser);var _userList=sessionStorage.getItem('userList');if(_userList!==null){setuserList(JSON.parse(_userList));}}else{var key=sessionStorage.getItem('myID');var _currentChatList=sessionStorage.getItem('currentChatList');if(key){setmyID(key);onopen(key);if(_currentChatList){currentChatList.current=JSON.parse(_currentChatList);setchatList(JSON.parse(_currentChatList));}}else{getNewUser();}}},[]);useEffect(function(){},[chatList]);useEffect(function(){// 客服初始化\nif(!userName&&!userActive&&userList&&adminUser==='admin'){// debugger\nconsole.log(userList[0].userName);var _userName=userList[0].userName;var key=userList[0].key;currentUserActive.current=key;currentUserActive.current=_userName;setuserActive(userList[0].key);setuseruserName(userList[0].userName);}},[userList]);/**\r\n     * 不是admin 生成新用户\r\n     * @param  \r\n     */var getNewUser=function getNewUser(){var url=httpUrl+\"/chat/getRoomProof\";axios.get(url).then(function(response){var res=response.data;if(200===res.success){setmyID(res.data);sessionStorage.setItem('myID',res.data);onopen(res.data);}});};/*\r\n     * 加入到房间\r\n     */var onopen=function onopen(proof){// let addRoomUrl = 'ws://127.0.0.1:9004/chat-room/' + proof;\nvar addRoomUrl=wsUrl+'/chat-room/'+proof;ws=new WebSocket(addRoomUrl);// 连接\nws.onopen=function(){console.log(\"[\"+proof+\"] 加入连接...\");};// 接收消息\nws.onmessage=function(event){// 服务端发送的消息\nvar dto=JSON.parse(event.data);// flag\nvar sender=dto.sender,message=dto.message,flag=dto.flag;if(adminUser==='admin'){// 客服\nvar _userList=currentUserList.current||[];var _isExistUser=isExistUser(sender,_userList),state=_isExistUser.state,_index=_isExistUser.index;if(flag===0){// 聊天\n}if(flag===1&&sender!==\"admin\"){// 进入聊天\nif(_userList.length===0||!state){// 没有用户 或者 不在用户列表中\n_userList.unshift({key:sender,flag:flag,userName:sender,charList:[{sender:\"admin\",message:'你好'}]});}if(state){// 存在用户列表中 \n_userList[_index].flag=flag;}}if(flag===2){//离开 \nif(_userList.length!==0){var leave=_userList.splice(_index,1)[0];leave['flag']=flag;_userList.push(leave);}}if(_userList.length!==0){currentUserList.current=_userList;sessionStorage.setItem(\"userList\",JSON.stringify(_userList));setuserList(_toConsumableArray(_userList));}}else{// 用户\nvar _currentChatList=currentChatList.current||[];if(flag===0){// 聊天\n_currentChatList.push({sender:sender,message:message});}if(flag===1&&!sessionStorage.getItem('currentChatList')){// 进入聊天\n_currentChatList.push({sender:\"admin\",message:'你好'});}currentChatList.current=_currentChatList;setchatList(_toConsumableArray(_currentChatList));sessionStorage.setItem(\"currentChatList\",JSON.stringify(_currentChatList));}};// 关闭连接\nws.onclose=function(){// $('#message_content').append('[' + proof + '] 离开了聊天室!');\n// console.log(\"[\" + proof + \"] 退出连接...\");\n};};// 判断用户是否存着客户聊天列表\nvar isExistUser=function isExistUser(key,userList){var state=false,index=0;userList.forEach(function(element,idx){if(element.key===key){state=true;index=idx;}});return{state:state,index:index};};// 发送消息\nvar sendMessage=function sendMessage(){if(!msg){_message.error(\"请输入消息内容\");return false;}var sendToHimUrl;var param;if(adminUser===\"admin\"){sendToHimUrl=httpUrl+'/chat/admin/sendToHim';param={who:userActive,msg:msg};}else{sendToHimUrl=httpUrl+'/chat/'+myID+'/sendToHim';param={who:\"admin\",msg:msg};}axios.post(sendToHimUrl,param).then(function(response){var res=response.data;if(200===res.success){// 清空发送的消息\nsetmessage(\"\");}else{setmessage(\"\");_message.error(res.message);}});};// 连接的是哪个客服\nvar getCustomerService=function getCustomerService(sessionIds){var cName=\"\";if(sessionIds){sessionIds.forEach(function(element){if(element.indexOf(\"admin\")!==-1){cName=element;}});}return cName;};return/*#__PURE__*/_jsx(\"section\",{className:\"chat-window\",children:/*#__PURE__*/_jsx(\"section\",{className:\"chat-pc\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"char-content\",children:[adminUser==='admin'?/*#__PURE__*/_jsxs(\"div\",{className:\"chat-left\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"search\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\"}),/*#__PURE__*/_jsx(\"span\",{className:\"icon\"})]}),userList&&userList.length&&userList.map(function(item){return/*#__PURE__*/_jsxs(\"div\",{className:userActive===item.userName?'active chat-row':'chat-row',onClick:function onClick(){return onClickSelectUser(item);},children:[/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"img\",{src:boy,alt:\"\"})}),/*#__PURE__*/_jsx(\"span\",{children:item.userName})]},item.key);})]}):\"\",/*#__PURE__*/_jsxs(\"div\",{className:\"chat-right\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"right-title\",children:userName}),/*#__PURE__*/_jsxs(\"div\",{className:\"right-msg\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"connect-msg\",children:adminUser?\"\".concat(adminUser,\"\\u8FDE\\u63A5\\u6210\\u529F\"):\"\\u5BA2\\u670D\".concat(getCustomerService(sessionIds),\"\\u4E3A\\u4F60\\u670D\\u52A1\")}),adminUser==='admin'?/*#__PURE__*/_jsxs(\"div\",{className:\"chat\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-msg left\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"girl\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u6492\\u5927\\u58F0\\u5730\\u4ED8 \\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-msg right\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"girl\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u6492\\u5927\\u58F0\\u5730\\u4ED8 \\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\\u6492\\u5927\\u58F0\\u5730\\u4ED8\\u591A\\u6492\\u6240\\u591A\"})]})]}):/*#__PURE__*/_jsx(\"div\",{className:\"chat\",children:chatList&&chatList.length&&chatList.map(function(item,index){if(item.sender==='admin'){return/*#__PURE__*/_jsxs(\"div\",{className:\"chat-msg left\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"girl\"}),/*#__PURE__*/_jsx(\"span\",{children:item.message})]},index);}else{return/*#__PURE__*/_jsxs(\"div\",{className:\"chat-msg right\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"girl\"}),/*#__PURE__*/_jsx(\"span\",{children:item.message})]},index);}})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"right-send\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"send-push\",children:/*#__PURE__*/_jsx(TextArea,{value:msg,onChange:function onChange(e){return setmessage(e.target.value);},autoSize:{minRows:3,maxRows:3}})}),/*#__PURE__*/_jsx(\"div\",{className:\"send-btn\",onClick:sendMessage,children:/*#__PURE__*/_jsx(\"button\",{children:\"\\u53D1\\u9001\"})})]})]})]})})});};export default ChatPC;function item(item,index){throw new Error('Function not implemented.');}function index(item,index){throw new Error('Function not implemented.');}","map":{"version":3,"sources":["D:/project/lingye/src/pages/chat/index.tsx"],"names":["React","useEffect","useRef","useState","Cookies","axios","TextArea","boy","require","default","girl","ChatPC","ws","httpUrl","wsUrl","currentUserList","currentUserActive","currentChatList","userList","setuserList","chatList","setchatList","sessionIds","setsessionIds","userActive","setuserActive","userName","setuseruserName","get","adminUser","msg","setmessage","myID","setmyID","onClickSelectUser","item","key","current","onopen","_userList","sessionStorage","getItem","JSON","parse","_currentChatList","getNewUser","console","log","url","then","response","res","data","success","setItem","proof","addRoomUrl","WebSocket","onmessage","event","dto","sender","message","flag","isExistUser","state","index","length","unshift","charList","leave","splice","push","stringify","onclose","forEach","element","idx","sendMessage","error","sendToHimUrl","param","who","post","getCustomerService","cName","indexOf","map","e","target","value","minRows","maxRows","Error"],"mappings":"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","sourcesContent":["import { Input, message } from 'antd';\r\nimport React, { useEffect, useRef, useState } from 'react'\r\nimport Cookies from \"js-cookie\";\r\nimport axios from \"axios\";\r\nimport './style.less'\r\nconst { TextArea } = Input;\r\nconst boy = require('../../assets/boy.png').default;\r\nconst girl = require('../../assets/girl.png').default;\r\nconst ChatPC: React.FC = () => {\r\n    // socket\r\n    let ws;\r\n    let httpUrl = \"http://websocket.sendcmd.com\";\r\n    let wsUrl = \"ws://websocket.sendcmd.com:9004\";\r\n    // let httpUrl = \"http://192.168.3.17:9004\";\r\n    // let wsUrl = \"ws://192.168.3.17:9004\";\r\n    let currentUserList: any = useRef()\r\n    let currentUserActive: any = useRef() // 选中的聊天用户\r\n    let currentChatList: any = useRef() // 用户聊天列表\r\n    const [userList, setuserList] = useState<Array<any>>() // 客服聊天列表\r\n    const [chatList, setchatList] = useState<Array<any>>() // 用户聊天列表\r\n    const [sessionIds, setsessionIds] = useState<Array<any>>()\r\n    const [userActive, setuserActive] = useState<string | undefined>();\r\n    const [userName, setuseruserName] = useState<string | undefined>();\r\n    const [adminUser] = useState(Cookies.get(\"user\"))\r\n    const [msg, setmessage] = useState<any>(\"\")\r\n    const [myID, setmyID] = useState<string>()\r\n    const onClickSelectUser = (item: any): void => {\r\n        setuserActive(item.key);\r\n        currentUserActive.current = item.key;\r\n        currentUserActive.current = item.key;\r\n        setuseruserName(item.userName)\r\n    }\r\n    useEffect(() => {\r\n        if (adminUser === 'admin') {\r\n            onopen(adminUser);\r\n            let _userList = sessionStorage.getItem('userList')\r\n            if (_userList !== null) {\r\n                setuserList(JSON.parse(_userList))\r\n            }\r\n        } else {\r\n            let key = sessionStorage.getItem('myID')\r\n            let _currentChatList = sessionStorage.getItem('currentChatList')\r\n            if (key) {\r\n                setmyID(key)\r\n                onopen(key);\r\n                if (_currentChatList) {\r\n                    currentChatList.current = JSON.parse(_currentChatList);\r\n                    setchatList(JSON.parse(_currentChatList))\r\n                }\r\n            } else {\r\n                getNewUser()\r\n            }\r\n        }\r\n    }, [])\r\n    useEffect(() => {\r\n\r\n    }, [chatList])\r\n\r\n    useEffect(() => { // 客服初始化\r\n        if (!userName && !userActive && userList && adminUser === 'admin') {\r\n            // debugger\r\n            console.log(userList[0].userName);\r\n            let userName = userList[0].userName\r\n            let key = userList[0].key\r\n            currentUserActive.current = key;\r\n            currentUserActive.current = userName;\r\n            setuserActive(userList[0].key);\r\n            setuseruserName(userList[0].userName)\r\n        }\r\n    }, [userList])\r\n\r\n    /**\r\n     * 不是admin 生成新用户\r\n     * @param  \r\n     */\r\n    const getNewUser = () => {\r\n        let url = httpUrl + \"/chat/getRoomProof\";\r\n        axios.get(url).then(response => {\r\n            let res = response.data;\r\n            if (200 === res.success) {\r\n                setmyID(res.data)\r\n                sessionStorage.setItem('myID', res.data)\r\n                onopen(res.data);\r\n            }\r\n        });\r\n    }\r\n    /*\r\n     * 加入到房间\r\n     */\r\n    const onopen = (proof: string) => {\r\n        // let addRoomUrl = 'ws://127.0.0.1:9004/chat-room/' + proof;\r\n        let addRoomUrl = wsUrl + '/chat-room/' + proof;\r\n        ws = new WebSocket(addRoomUrl);\r\n\r\n        // 连接\r\n        ws.onopen = () => {\r\n            console.log(\"[\" + proof + \"] 加入连接...\");\r\n        };\r\n\r\n        // 接收消息\r\n        ws.onmessage = (event) => {\r\n            // 服务端发送的消息\r\n            let dto = JSON.parse(event.data);\r\n            // flag\r\n            const { sender, message, flag } = dto;\r\n            if (adminUser === 'admin') { // 客服\r\n                let _userList = currentUserList.current || [];\r\n                const { state, index } = isExistUser(sender, _userList);\r\n                if (flag === 0) { // 聊天\r\n\r\n                }\r\n                if (flag === 1 && sender !== \"admin\") { // 进入聊天\r\n                    if (_userList.length === 0 || !state) { // 没有用户 或者 不在用户列表中\r\n                        _userList.unshift({ key: sender, flag, userName: sender, charList: [{ sender: \"admin\", message: '你好' }] })\r\n                    }\r\n                    if (state) { // 存在用户列表中 \r\n                        _userList[index].flag = flag\r\n                    }\r\n                }\r\n                if (flag === 2) { //离开 \r\n                    if (_userList.length !== 0) {\r\n                        let leave = _userList.splice(index, 1)[0];\r\n                        leave['flag'] = flag;\r\n                        _userList.push(leave)\r\n                    }\r\n                }\r\n                if (_userList.length !== 0) {\r\n                    currentUserList.current = _userList;\r\n                    sessionStorage.setItem(\"userList\", JSON.stringify(_userList));\r\n                    setuserList([..._userList])\r\n                }\r\n            } else { // 用户\r\n                let _currentChatList = currentChatList.current || [];\r\n                if (flag === 0) { // 聊天\r\n                    _currentChatList.push({ sender, message });\r\n                }\r\n                if (flag === 1 && !sessionStorage.getItem('currentChatList')) { // 进入聊天\r\n                    _currentChatList.push({ sender: \"admin\", message: '你好' })\r\n                }\r\n                currentChatList.current = _currentChatList;\r\n                setchatList([..._currentChatList])\r\n                sessionStorage.setItem(\"currentChatList\", JSON.stringify(_currentChatList));\r\n            }\r\n        };\r\n\r\n        // 关闭连接\r\n        ws.onclose = () => {\r\n            // $('#message_content').append('[' + proof + '] 离开了聊天室!');\r\n            // console.log(\"[\" + proof + \"] 退出连接...\");\r\n        }\r\n    }\r\n    // 判断用户是否存着客户聊天列表\r\n    const isExistUser = (key: string, userList: any) => {\r\n        let state = false, index = 0;\r\n        userList.forEach((element: any, idx: number) => {\r\n            if (element.key === key) {\r\n                state = true;\r\n                index = idx;\r\n            }\r\n        });\r\n        return { state, index };\r\n    }\r\n    // 发送消息\r\n    const sendMessage = () => {\r\n        if (!msg) {\r\n            message.error(\"请输入消息内容\");\r\n            return false\r\n        }\r\n        let sendToHimUrl: string;\r\n        let param: any;\r\n        if (adminUser === \"admin\") {\r\n            sendToHimUrl = httpUrl + '/chat/admin/sendToHim'\r\n            param = {\r\n                who: userActive,\r\n                msg: msg\r\n            }\r\n        } else {\r\n            sendToHimUrl = httpUrl + '/chat/' + myID + '/sendToHim'\r\n            param = {\r\n                who: \"admin\",\r\n                msg: msg\r\n            }\r\n        }\r\n        axios.post(sendToHimUrl, param).then((response: { data: any; }) => {\r\n            let res = response.data;\r\n            if (200 === res.success) {\r\n                // 清空发送的消息\r\n                setmessage(\"\")\r\n            } else {\r\n                setmessage(\"\")\r\n                message.error(res.message)\r\n            }\r\n        })\r\n    }\r\n    // 连接的是哪个客服\r\n    const getCustomerService = (sessionIds: any) => {\r\n        let cName: string = \"\";\r\n        if (sessionIds) {\r\n            sessionIds.forEach((element: any) => {\r\n                if (element.indexOf(\"admin\") !== -1) {\r\n                    cName = element\r\n                }\r\n            });\r\n        }\r\n        return cName;\r\n    }\r\n\r\n    return (\r\n        <section className='chat-window'>\r\n            <section className='chat-pc'>\r\n                <div className='char-content'>\r\n                    {\r\n                        adminUser === 'admin' ? <div className='chat-left'>\r\n                            <div className='search'>\r\n                                <input type=\"text\" />\r\n                                <span className='icon'></span>\r\n                            </div>\r\n                            {\r\n                                userList && userList.length && userList.map((item: any) => {\r\n                                    return <div\r\n                                        key={item.key}\r\n                                        className={userActive === item.userName ? 'active chat-row' : 'chat-row'}\r\n                                        onClick={() => onClickSelectUser(item)}\r\n                                    >\r\n                                        <div >\r\n                                            <img src={boy} alt=\"\" />\r\n                                        </div>\r\n                                        <span>{item.userName}</span>\r\n                                    </div>\r\n                                })\r\n                            }\r\n                        </div> : \"\"\r\n                    }\r\n\r\n                    <div className='chat-right'>\r\n                        <div className='right-title'>{userName}</div>\r\n                        <div className='right-msg'>\r\n                            <div className='connect-msg'>\r\n                                {adminUser ? `${adminUser}连接成功` : `客服${getCustomerService(sessionIds)}为你服务`}\r\n                            </div>\r\n                            {\r\n                                adminUser === 'admin' ? <div className='chat'>\r\n                                    <div className='chat-msg left'>\r\n                                        <span className='girl'></span>\r\n                                        <span>\r\n                                            撒大声地付\r\n                                            多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多\r\n                                            {/* <span className=\"arrow\"></span> */}\r\n                                        </span>\r\n                                    </div>\r\n                                    <div className='chat-msg right'>\r\n                                        <span className='girl'></span>\r\n                                        <span>\r\n                                            撒大声地付\r\n                                            多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多撒大声地付多撒所多\r\n                                            {/* <span className=\"arrow\"></span> */}\r\n                                        </span>\r\n                                    </div>\r\n                                </div> : <div className='chat'>\r\n                                    {chatList && chatList.length && chatList.map((item, index) => {\r\n                                        if (item.sender === 'admin') {\r\n                                            return <div className='chat-msg left' key={index}>\r\n                                                <span className='girl'></span>\r\n                                                <span>{item.message}</span>\r\n                                            </div>\r\n                                        } else {\r\n                                            return <div className='chat-msg right' key={index}>\r\n                                                <span className='girl'></span>\r\n                                                <span>{item.message}</span>\r\n                                            </div>\r\n                                        }\r\n                                    })}\r\n\r\n\r\n                                </div>\r\n                            }\r\n\r\n                        </div>\r\n                        <div className='right-send'>\r\n                            <div className='send-push'>\r\n                                <TextArea\r\n                                    value={msg}\r\n                                    onChange={(e) => setmessage(e.target.value)\r\n                                    }\r\n                                    autoSize={{ minRows: 3, maxRows: 3 }}\r\n                                />\r\n                            </div>\r\n                            <div className='send-btn' onClick={sendMessage}>\r\n                                <button>发送</button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </section>\r\n        </section>\r\n    )\r\n}\r\n\r\nexport default ChatPC\r\n\r\nfunction item(item: any, index: any): string | number | boolean | {} | React.ReactElement<any, string | React.JSXElementConstructor<any>> | React.ReactNodeArray | React.ReactPortal | null | undefined {\r\n    throw new Error('Function not implemented.');\r\n}\r\nfunction index(item: (item: any, index: any) => string | number | boolean | {} | React.ReactElement<any, string | React.JSXElementConstructor<any>> | React.ReactNodeArray | React.ReactPortal | null | undefined, index: any): string | number | boolean | {} | React.ReactElement<any, string | React.JSXElementConstructor<any>> | React.ReactNodeArray | React.ReactPortal | null | undefined {\r\n    throw new Error('Function not implemented.');\r\n}\r\n\r\n"]},"metadata":{},"sourceType":"module"}